<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" charset='utf-8'.>
  <style >.hogehoge {
    padding: 20px;
    margin: 20px;
  }</style>
</head>
<body>

  <div class="camera">
    <video id="video"></video>
    <canvas id="movie"></canvas>
    <!-- <video id="test" width="500" height="400" controls></video> -->
</div><br>



<button class="hogehoge" type="button" id="start">start</button>
<button class="hogehoge" type="button" id="stop">stop</button>
<!-- <botton type="button" id="download">dl</botton> -->



<script>
  var startbutton = document.getElementById('start')
  var stopbutton  = document.getElementById('stop')
  // var downloadbutton = document.getElementById('download')
  var video = document.getElementById('video')// 適当にvideoタグのオブジェクトを取得
  var constrains = { video: true, audio: true, facingMode: "user" }// 映像・音声を取得するかの設定
  var downloaddata = []
  let str = 0;
    // まずはユーザーのカメラ・マイクへのアクセスを実施
    navigator.mediaDevices.getUserMedia(constrains)
  .then(function (stream) {
    video.srcObject = stream // streamはユーザーのカメラとマイクの情報で、これをvideoの入力ソースにする
    video.play()
    
    const mime = MediaRecorder.isTypeSupported("video/webm; codecs=vp9") ? "video/webm; codecs=vp9" : "video/webm"
    // console.log(mine)
    recorder = new MediaRecorder(stream, { mimeType: mime }) // 映像の入力ソースをユーザーのデバイスから取得
    recorder.ondataavailable = function (e) {
      // var testvideo = document.getElementById('test')
      // testvideo.setAttribute('controls', '')
      // testvideo.setAttribute('width', 500)
      // testvideo.setAttribute('height', 400)
      // var outputdata = window.URL.createObjectURL(e.data) // videoタグが扱えるように、記録データを加工
      // testvideo.src = outputdata // テスト用のビデオのソースに記録データを設置
      if(e.data){
      downloaddata.push(e.data)
      console.log("dl")
      }
    }
    
  })

  .catch(function(err) {
      console.log("An error occured! " + err)
  })

  startbutton.addEventListener('click', function(ev){
    recorder.start(10000)
    ev.preventDefault()
  }, false);

  stopbutton.addEventListener('click', function(ev) {
    recorder.stop()
    
    setTimeout(() => {
      console.log(downloaddata)
      var blob = new Blob(downloaddata, { type:  "video/webm"})// 録画ファイルをblob形式に出力
      var url = window.URL.createObjectURL(blob) // データにアクセスするためのURLを作成
      downloaddata = []
      var a = document.createElement('a') // download属性を持ったaタグをクリックするとダウンロードができるので、それをシミュレートする
      document.body.appendChild(a)
      a.style = 'display:none'
      a.href = url;
      a.download =  'test' + str + '.webm'
      str++
      a.click()
      window.URL.revokeObjectURL(url)
    }, 0);
  })

  window.addEventListener('load' , function(){
    var movie = document.getElementById("movie")
    const ctx = movie.getContext("2d")
    for(;1;){
      ctx.drawImage(video, 0, 0)
    }
  })

</script>
</body>
</html>